# This is the load balancer file for the EROS cida.usgs.gov

RewriteEngine ON

# This was added for CouchDB
AllowEncodedSlashes NoDecode

##
## We set the X-REQUEST-URL url here.
##

RewriteRule .? - [E=SERVER_NAME:%{LA-U:SERVER_NAME}]
RewriteRule .? - [E=REQUEST_URI:%{LA-U:REQUEST_URI}]
RequestHeader set X-REQUEST-URL "https://cida.usgs.gov%{REQUEST_URI}e" env=HTTPS
RequestHeader set X-UNSAFE-REQUEST-URL "https://%{SERVER_NAME}e%{REQUEST_URI}e" env=HTTPS
RequestHeader set X-REQUEST-URL "http://cida.usgs.gov%{REQUEST_URI}e" env=!HTTPS
RequestHeader set X-UNSAFE-REQUEST-URL "http://%{SERVER_NAME}e%{REQUEST_URI}e" env=!HTTPS

##
## /thredds (NONE) --dekester
##

RewriteRule ^/thredds$ /thredds/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/thredds/(.*)$ balancer://eros-apaprod-cida/thredds/$1 [P,L]
RewriteRule ^/thredds/(.*)$ balancer://eros-apaprod-cidassl/thredds/$1 [P,L]

##
## /gdp (NONE) --dekester
##

RewriteRule ^/gdp$ /gdp/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/gdp/(.*)$ balancer://eros-apaprod-cida/gdp/$1 [P,L]
RewriteRule ^/gdp/(.*)$ balancer://eros-apaprod-cidassl/gdp/$1 [P,L]

##
## /nwc INFRA-1174 --stephan
##

RewriteRule ^/nwc$ /nwc/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/nwc/(.*)$ balancer://eros-apaprod-cida/nwc/$1 [P,L]
RewriteRule ^/nwc/(.*)$ balancer://eros-apaprod-cidassl/nwc/$1 [P,L]

##
## /qa/nwc INFRA-1174 --stephan
##
RewriteRule ^/qa/nwc$ /qa/nwc/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/qa/nwc/(.*)$ balancer://eros-apaprod-cida/qa/nwc/$1 [P,L]
RewriteRule ^/qa/nwc/(.*)$ balancer://eros-apaprod-cidassl/qa/nwc/$1 [P,L]

##
## /climate/derivative (INFRA-788) --dekester
##

RewriteRule ^/climate/derivative$ /climate/derivative/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/climate/derivative/(.*)$ balancer://wiwsc-apaprod-cida/climate/derivative/$1 [P,L]
RewriteRule ^/climate/derivative/(.*)$ balancer://wiwsc-apaprod-cidassl/climate/derivative/$1 [P,L]

##
## /climate (INFRA-788) --dekester
##

RewriteRule ^/climate$ /climate/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/climate/(.*)$ balancer://eros-apaprod-cida/climate/$1 [P,L]
RewriteRule ^/climate/(.*)$ balancer://eros-apaprod-cidassl/climate/$1 [P,L]

##
## /test_eros
##

RewriteRule ^/test_eros$ /test_eros/request_test.jsp [R=301,L]
RewriteRule ^/test_eros/(.*)$ balancer://eros-apaprod-cida/test_eros/$1 [P,L]

##
## /sparrow --dekester/sstephan
##

RewriteRule ^/sparrow$ /sparrow/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/sparrow/(.*)$ balancer://eros-apaprod-cida/sparrow/$1 [P,L]
RewriteRule ^/sparrow/(.*)$ balancer://eros-apaprod-cidassl/sparrow/$1 [P,L]

##
## /sparrow_migration --dekester
##

RewriteRule ^/sparrow_migration$ /sparrow_migration/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/sparrow_migration/(.*)$ balancer://eros-apaprod-cida/sparrow/$1 [P,L]
RewriteRule ^/sparrow_migration/(.*)$ balancer://eros-apaprod-cidassl/sparrow/$1 [P,L]

<Location /sparrow_migration>
   AddOutputFilterByType SUBSTITUTE text/html
   AddOutputFilterByType SUBSTITUTE application/xml
   Header edit Location cida.usgs.gov/sparrow/ cida.usgs.gov/sparrow_migration/
   Header edit Location cida.usgs.gov/sparrow_mv/ cida.usgs.gov/sparrow_mv_migration/
</Location>

##
## /sparrow_mv --dekester/sstephan
##

RewriteRule ^/sparrow_mv$ /sparrow_mv/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/sparrow_mv/(.*)$ balancer://eros-apaprod-cida/sparrow_mv/$1 [P,L]
RewriteRule ^/sparrow_mv/(.*)$ balancer://eros-apaprod-cidassl/sparrow_mv/$1 [P,L]

##
## /sparrow_mv_eros --INFRA-1212 sstephan
##

RewriteRule ^/sparrow_mv_eros$ /sparrow_mv_eros/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/sparrow_mv_eros/(.*)$ balancer://eros-apaprod-cida/sparrow_mv/$1 [P,L]
RewriteRule ^/sparrow_mv_eros/(.*)$ balancer://eros-apaprod-cidassl/sparrow_mv/$1 [P,L]

##
## /sparrow_mv_migration --dekester
##

RewriteRule ^/sparrow_mv_migration$ /sparrow_mv_migration/ [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^/sparrow_mv_migration/(.*)$ balancer://eros-apaprod-cida/sparrow_mv/$1 [P,L]
RewriteRule ^/sparrow_mv_migration/(.*)$ balancer://eros-apaprod-cidassl/sparrow_mv/$1 [P,L]

<Location /sparrow_mv_migration>
   AddOutputFilterByType SUBSTITUTE text/html
   AddOutputFilterByType SUBSTITUTE application/xml
   Header edit Location cida.usgs.gov/sparrow/ cida.usgs.gov/sparrow_migration/
   Header edit Location cida.usgs.gov/sparrow_mv/ cida.usgs.gov/sparrow_mv_migration/
</Location>

##
## / (NONE) --dekester
##

RewriteCond %{HTTPS} off
RewriteCond %{REQUEST_URI} !^/nc.html
RewriteRule ^/(.*)$ balancer://wiwsc-apaprod-cida/$1 [P,L]
RewriteCond %{REQUEST_URI} !^/nc.html
RewriteRule ^/(.*)$ balancer://wiwsc-apaprod-cidassl/$1 [P,L]

# <Location />
#    # Please remove these lines once EROS goes live.
#    AddOutputFilterByType SUBSTITUTE text/html
#    Substitute "s|cida.usgs.gov|10.165.135.10|nq"
#    Header edit Location cida.usgs.gov 10.165.135.10 
# </Location>

# vim: syntax=apache tw=200 expandtab tabstop=4 softtabstop=4 showmatch nocompatible shiftwidth=4 ai
